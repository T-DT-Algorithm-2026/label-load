# ==============================================================================
# LabelLoad Release Pipeline
# ==============================================================================
# è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ DEB åŒ…
#
# è§¦å‘æ¡ä»¶:
#   - æ¨é€æ ‡ç­¾ v*.*.*
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# å‘å¸ƒäº§ç‰©:
#   - label-load_ç‰ˆæœ¬_amd64.deb (CPU ç‰ˆæœ¬, ~18MB)
#   - label-load_ç‰ˆæœ¬_gpu_amd64.deb (GPU ç‰ˆæœ¬, ~120MB)
# ==============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.4)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.27.4'
  ORT_VERSION: '1.20.0'

jobs:
  # ============================================================================
  # æ„å»º CPU ç‰ˆæœ¬
  # ============================================================================
  build-cpu:
    name: ğŸ“¦ Build CPU Package
    runs-on: ubuntu-22.04
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      deb_name: ${{ steps.build.outputs.deb_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Building version: $VERSION"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            imagemagick

      - name: Install ONNX Runtime (CPU)
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz"
          tar -xzf "onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz"
          sudo cp onnxruntime-linux-x64-${{ env.ORT_VERSION }}/lib/*.so* /usr/local/lib/
          sudo cp -r onnxruntime-linux-x64-${{ env.ORT_VERSION }}/include/* /usr/local/include/
          sudo ldconfig

      - name: Build release
        run: ./run.sh release

      - name: Package DEB (CPU)
        id: build
        run: |
          ./run.sh deb --cpu --version ${{ steps.version.outputs.version }}
          DEB_FILE=$(ls build/deb/*.deb | head -1)
          DEB_NAME=$(basename "$DEB_FILE")
          echo "deb_name=$DEB_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Built: $DEB_NAME"

      - name: Upload CPU artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-cpu
          path: build/deb/*.deb
          retention-days: 7

  # ============================================================================
  # æ„å»º GPU ç‰ˆæœ¬
  # ============================================================================
  build-gpu:
    name: ğŸ“¦ Build GPU Package
    runs-on: ubuntu-22.04
    needs: build-cpu
    
    outputs:
      deb_name: ${{ steps.build.outputs.deb_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            imagemagick

      - name: Install ONNX Runtime (GPU)
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-linux-x64-gpu-${{ env.ORT_VERSION }}.tgz"
          tar -xzf "onnxruntime-linux-x64-gpu-${{ env.ORT_VERSION }}.tgz"
          sudo cp onnxruntime-linux-x64-gpu-${{ env.ORT_VERSION }}/lib/*.so* /usr/local/lib/
          sudo cp -r onnxruntime-linux-x64-gpu-${{ env.ORT_VERSION }}/include/* /usr/local/include/
          sudo ldconfig

      - name: Build release
        run: ./run.sh release

      - name: Package DEB (GPU)
        id: build
        run: |
          ./run.sh deb --gpu --version ${{ needs.build-cpu.outputs.version }}
          DEB_FILE=$(ls build/deb/*gpu*.deb | head -1)
          DEB_NAME=$(basename "$DEB_FILE")
          echo "deb_name=$DEB_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Built: $DEB_NAME"

      - name: Upload GPU artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-gpu
          path: build/deb/*.deb
          retention-days: 7

  # ============================================================================
  # åˆ›å»º GitHub Release
  # ============================================================================
  release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-cpu, build-gpu]
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download CPU artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-cpu
          path: artifacts/

      - name: Download GPU artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-gpu
          path: artifacts/

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.build-cpu.outputs.version }}"
          cat << 'EOF' > release_notes.md
          ## LabelLoad v${{ needs.build-cpu.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½ / Downloads
          
          | ç‰ˆæœ¬ | æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
          |------|------|------|------|
          | CPU | `${{ needs.build-cpu.outputs.deb_name }}` | ~18MB | æ— éœ€ CUDAï¼Œé€‚åˆå¤§å¤šæ•°ç”¨æˆ· |
          | GPU | `${{ needs.build-gpu.outputs.deb_name }}` | ~120MB | éœ€è¦ NVIDIA CUDA Toolkit |
          
          ### ğŸ“‹ å®‰è£… / Installation
          
          ```bash
          # CPU ç‰ˆæœ¬
          sudo apt install ./${{ needs.build-cpu.outputs.deb_name }}
          
          # GPU ç‰ˆæœ¬ (éœ€è¦å…ˆå®‰è£… CUDA Toolkit)
          sudo apt install nvidia-cuda-toolkit
          sudo apt install ./${{ needs.build-gpu.outputs.deb_name }}
          ```
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚ / Requirements
          
          - Ubuntu 22.04+ (GLib 2.72+)
          - GPU ç‰ˆæœ¬éœ€è¦: CUDA 11.x + cuDNN 8.x
          
          ---
          
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: LabelLoad v${{ needs.build-cpu.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            artifacts/*.deb
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

